/*
 * flickrBomb v1
 * www.ZURB.com/playground
 * Copyright 2011, ZURB
 * Free to use under the MIT license.
 * http://www.opensource.org/licenses/mit-license.php
*/// Optionally pass a Flickr API key on instantiation
var flickrBomb=function a(b){function g(){try{return"localStorage"in window&&window.localStorage!==null}catch(a){return!1}}if(!(this instanceof a))return new a;var c=b||"66b5c17019403c96779e8fe88d5b576d",d="",e,f;if(!c)return new Error("flickr API key required");if(g()){var h=function(){return((1+Math.random())*65536|0).toString(16).substring(1)},i=function(){return h()+h()+"-"+h()+"-"+h()+"-"+h()+"-"+h()+h()+h()},j=function(a){this.name=a;var b=window.localStorage.getItem(this.name);this.data=b&&JSON.parse(b)||{}};_.extend(j.prototype,{save:function(){window.localStorage.setItem(this.name,JSON.stringify(this.data))},create:function(a){return a.id||(a.id=a.attributes.id=i()),this.data[a.id]=a,this.save(),a},update:function(a){return this.data[a.id]=a,this.save(),a},find:function(a){return this.data[a.id]},findAll:function(){return _.values(this.data)},destroy:function(a){return delete this.data[a.id],this.save(),a}}),f=function(a,b,c){var d,e=b.localStorage||b.collection.localStorage;switch(a){case"read":d=b.id?e.find(b):e.findAll();break;case"create":d=e.create(b);break;case"update":d=e.update(b);break;case"delete":d=e.destroy(b)}d&&c&&c.success&&c.success(d)},e=new j("flickrBombImages")}else e=null;var k=Backbone.Model.extend({sync:f,fullsize_url:function(){return this.image_url("medium")},thumb_url:function(){return this.image_url("square")},image_url:function(a){var b;switch(a){case"square":b="_s";break;case"medium":b="_z";break;case"large":b="_b";break;default:b=""}return"http://farm"+this.get("farm")+".static.flickr.com/"+this.get("server")+"/"+this.get("id")+"_"+this.get("secret")+b+".jpg"}}),l=Backbone.Model.extend({sync:f,localStorage:e,initialize:function(){_.bindAll(this,"loadFirstImage"),this.flickrImages=new m,this.flickrImages.fetch(this.get("keywords"),this.loadFirstImage),this.set({id:this.get("id")||this.get("keywords")}),this.bind("change:src",this.changeSrc)},changeSrc:function(){this.save()},loadFirstImage:function(){this.get("src")===undefined&&this.set({src:this.flickrImages.first().image_url()})}}),m=Backbone.Collection.extend({sync:f,model:k,key:c,page:1,fetch:function(a,b){var c=this;b=b||$.noop,this.keywords=a||this.keywords,$.ajax({url:"http://api.flickr.com/services/rest/",data:{api_key:c.key,format:"json",method:"flickr.photos.search",tags:this.keywords,per_page:9,page:this.page,license:d},dataType:"jsonp",jsonp:"jsoncallback",success:function(a){c.add(a.photos.photo),b()}})},nextPage:function(a){this.page+=1,this.remove(this.models),this.fetch(null,a)},prevPage:function(a){this.page>1&&(this.page-=1),this.remove(this.models),this.fetch(null,a)}}),n=Backbone.View.extend({tagName:"a",template:_.template("<img src='<%= thumb_url() %>' />"),className:"photo",events:{click:"setImageSrc"},render:function(){return $(this.el).html(this.template(this.model)),$(this.el).addClass("photo"),this},setImageSrc:function(a){this.options.image.set({src:this.model.fullsize_url()})}}),o=Backbone.View.extend({tagName:"div",className:"flickrbombContainer",lock:!1,template:_.template('<div id="<%= id %>" class="flickrbombWrapper"><img class="flickrbomb" src="" /><a href="#" title="Setup" class="setupIcon"></a></div><div class="flickrbombFlyout"><div class="flickrbombContent"><a href="#" title="Previous Page" class="prev">&#9664;</a><a href="#" title="Next Page" class="next">&#9654;</a></div></div>'),initialize:function(a){_.bindAll(this,"addImage","updateSrc","setDimentions","updateDimentions");var b=a.img.attr("src").replace("flickr://","");this.$el=$(this.el),this.ratio=this.options.img.attr("data-ratio"),this.image=new l({keywords:b,id:a.img.attr("id")}),this.image.flickrImages.bind("add",this.addImage),this.image.bind("change:src",this.updateSrc)},events:{"click .setupIcon":"clickSetup","click .flickrbombFlyout a.photo":"selectImage","click .flickrbombFlyout a.next":"nextFlickrPhotos","click .flickrbombFlyout a.prev":"prevFlickrPhotos"},render:function(){return $(this.el).html(this.template({id:this.image.id.replace(" ","")})),this.image.fetch(),this.ratio?this.$(".flickrbombWrapper").append('<img style="width: 100%;" class="placeholder" src="http://placehold.it/'+this.ratio+'" />'):this.resize(),this},updateSrc:function(a,b){var c=this;this.$("img.flickrbomb").css({top:"auto",left:"auto",width:"auto",height:"auto"}).attr("src","").bind("load",c.setDimentions).attr("src",b)},setDimentions:function(a){this.image.set({width:this.$("img").width(),height:this.$("img").height()}),this.updateDimentions(this.image),$(a.target).unbind("load")},updateDimentions:function(){var a=this.$("img.flickrbomb"),b=this.image.get("width"),c=this.image.get("height"),d=b/c,e=this.$("div.flickrbombWrapper").width(),f=this.$("div.flickrbombWrapper").height(),g=e/f;d<g?(a.css({width:"100%",height:null}),a.css({top:(f-a.height())/2+"px",left:null})):(a.css({height:"100%",width:null}),a.css({left:(e-a.width())/2+"px",top:null}))},addImage:function(a){this.flickrImageView=new n({model:a,image:this.image}),this.$(".flickrbombFlyout").append(this.flickrImageView.render().el)},clickSetup:function(a){a.preventDefault(),this.toggleFlyout()},toggleFlyout:function(a){this.$(".flickrbombFlyout").toggle()},selectImage:function(a){a.preventDefault(),this.toggleFlyout()},nextFlickrPhotos:function(a){a.preventDefault();var b=this;this.lock||(this.lock=!0,this.$(".flickrbombFlyout").find("a.photo").remove(),this.image.flickrImages.nextPage(function(){b.lock=!1}))},prevFlickrPhotos:function(a){a.preventDefault();var b=this;this.lock||(this.lock=!0,this.$(".flickrbombFlyout").find("a.photo").remove(),this.image.flickrImages.prevPage(function(){b.lock=!1}))},resize:function(){this.$("div.flickrbombWrapper").css({width:this.width()+"px",height:this.height()+"px"})},width:function(){return parseInt(this.options.img.width(),10)},height:function(){return parseInt(this.options.img.height(),10)}});$("body").click(function(a){!$(a.target).closest(".setupIcon").length&&!$(a.target).closest(".flickrbombFlyout").length&&$(".flickrbombFlyout").hide()}),this.ImageView=o,this.bomb=function(){var a=this;$("img[src^='flickr://']").each(function(){var b=$(this),c=new a.ImageView({img:b});b.replaceWith(c.render().el)})}};